# Групповой этап соревнований по фехтованию

## Описание
Расширение приложения EnGarde для проведения группового этапа (poule) соревнований по фехтованию. Приложение должно поддерживать создание групп из 5-8 участников, автоматическое определение порядка боёв по таблицам FIE, проведение боёв с использованием существующего BoutScreen, отображение результатов в классической матрице FIE и полный алгоритм ранжирования.

## Цели и критерии успеха
- Судья может создать группу, провести все бои и получить итоговую таблицу с местами
- Одиночный бой остаётся доступным как отдельный режим
- Данные сохраняются между сессиями (Room)
- Результаты можно экспортировать в PDF

---

## Навигация приложения

### Главный экран (HomeScreen)
- При запуске — экран выбора режима:
  - **Одиночный бой** → текущий BoutScreen (как сейчас)
  - **Групповой этап** → экран создания/выбора группы
- Доступ к настройкам (существующий SettingsScreen)

### Флоу группового этапа
```
HomeScreen
  → GroupSetupScreen (создание группы + ввод участников)
    → GroupDashboardScreen (таблица + список боёв)
      → BoutConfirmScreen (подтверждение: кто фехтует)
        → BoutScreen (существующий, с именами)
          → BoutResultScreen (итог боя)
            → GroupDashboardScreen (обновлённая таблица)
```

---

## Экраны

### 1. GroupSetupScreen — Создание группы

**Настройки группы:**
- Количество участников: 5, 6, 7 или 8 (выбор)
- Режим боя: на 4 или 5 ударов
- Оружие: Сабля / Шпага-Рапира (влияет на правила BoutEngine)

**Ввод участников:**
- Для каждого участника:
  - **Имя** (обязательное поле)
  - **Организация** (опциональное)
  - **Регион** (опциональное)
- Автокомплит имён из ранее созданных участников (Room DB)
- Динамическое количество полей в зависимости от выбранного числа участников

**Действия:**
- Кнопка "Создать группу" — валидация (все имена заполнены, нет дубликатов) → переход к GroupDashboardScreen

### 2. GroupDashboardScreen — Таблица группы

**Основной контент — матрица FIE:**
- Таблица N×N (каждый против каждого)
- Строки и столбцы — участники (имя, номер)
- В ячейках — счёт боя (V5/D3 формат) или пусто (бой не проведён)
- Диагональ — затемнена (участник не фехтует сам с собой)
- Итоговые столбцы справа: V (победы), V/M%, TD (нанесённые), TR (пропущенные), Ind (индекс = TD-TR), Место

**Информационная панель:**
- Текущий бой: "Бой #N: Иванов vs Петров"
- Следующий бой: "Готовится: Сидоров vs Козлов"
- Прогресс: "Проведено X из Y боёв"

**Действия:**
- Кнопка "Начать следующий бой" → BoutConfirmScreen
- Список всех боёв (можно открыть отдельно) с результатами проведённых
- Редактирование счёта завершённого боя (только счёт, ручной ввод)
- Обработка неявок (отдельная кнопка/меню)
- Экспорт в PDF (после завершения всех боёв)

**Скролл:**
- Горизонтальный и вертикальный скролл для матрицы
- Закреплённая первая колонка (имена) и первая строка (номера)

### 3. BoutConfirmScreen — Подтверждение боя

- Показ: "Левая дорожка: [Имя] vs Правая дорожка: [Имя]"
- Номер боя, порядковый номер в группе
- Кнопка "Начать бой" → BoutScreen
- Кнопка "Отмена" → назад к GroupDashboardScreen

### 4. BoutScreen (существующий)

- Переиспользуется текущий BoutScreen
- Имена фехтовальщиков подставляются из группы (вместо "Left"/"Right")
- Режим (4 или 5) и оружие берутся из настроек группы
- По завершении боя — результат передаётся обратно в GroupEngine

### 5. BoutResultScreen — Результат боя

- Показ итога: "[Имя] V5 — D3 [Имя]" (или наоборот)
- Кнопка "Далее" → GroupDashboardScreen с обновлённой таблицей
- Информация о следующем бое и кто готовится

### 6. BoutsListScreen — Список всех боёв группы

- Полный список боёв в порядке FIE
- Для проведённых — счёт (V5/D3)
- Для непроведённых — пусто
- Возможность нажать на проведённый бой → редактирование счёта

---

## Порядок боёв (таблицы FIE)

Стандартные таблицы порядка боёв для групп:

### 5 участников (10 боёв)
```
1-2, 3-4, 5-1, 2-3, 5-4, 1-3, 2-5, 4-1, 3-5, 4-2
```

### 6 участников (15 боёв)
```
1-2, 4-5, 2-3, 5-6, 3-1, 6-4, 5-1, 2-6, 3-4, 6-1, 4-2, 5-3, 2-5, 1-4, 6-3
```

### 7 участников (21 бой)
```
1-4, 2-5, 3-6, 7-1, 5-4, 6-2, 7-3, 1-5, 4-6, 2-7, 3-5, 1-6, 7-4, 5-2, 6-3, 1-7, 4-2, 3-1, 5-7, 6-4, 2-3 (нужно уточнить!)
```

### 8 участников (28 боёв)
```
1-2, 3-4, 5-6, 7-8, 1-3, 2-4, 5-7, 6-8,
1-4, 2-3, 5-8, 6-7, 1-5, 2-6, 3-7, 4-8,
1-6, 2-5, 3-8, 4-7, 1-7, 2-8, 3-5, 4-6,
1-8, 2-7, 3-6, 4-5 (нужно уточнить!)
```

> **ВАЖНО:** Точные таблицы FIE необходимо верифицировать по официальному регламенту FIE перед реализацией.

---

## Алгоритм ранжирования FIE

Полный алгоритм определения мест в группе:

1. **V/M% (процент побед)** — Victories / Matches × 100
2. При равенстве V/M% → **Индекс ударов (Ind)** = TD - TR (touches delivered - touches received)
3. При равенстве Ind → **Нанесённые удары (TD)**
4. При равенстве TD → **Прямое противостояние** (результат личного боя между равными)

### Неявки и исключения
- **Неявка (forfeit):** Результат записывается как V{max}/D0 в пользу явившегося (max = 5 или 4 в зависимости от режима). Неявившийся получает D0/V{max}.
- **Исключение (exclusion, травма):** Спортсмен полностью исключается из группы. Все его прошедшие и будущие бои аннулируются. Таблица и ранжирование пересчитываются без этого спортсмена.

---

## Хранение данных (Room)

### Сущности

**Fencer (спортсмен)**
- id: Long (PK, auto)
- name: String
- organization: String?
- region: String?

**Pool (группа)**
- id: Long (PK, auto)
- createdAt: Long (timestamp)
- mode: Int (4 или 5)
- weapon: String (SABRE / FOIL_EPEE)
- status: String (IN_PROGRESS / COMPLETED)

**PoolFencer (участник группы)**
- id: Long (PK, auto)
- poolId: Long (FK → Pool)
- fencerId: Long (FK → Fencer)
- seedNumber: Int (номер в группе, 1-8)
- excluded: Boolean (исключён ли)

**PoolBout (бой в группе)**
- id: Long (PK, auto)
- poolId: Long (FK → Pool)
- boutOrder: Int (порядковый номер по FIE)
- leftFencerId: Long (FK → PoolFencer)
- rightFencerId: Long (FK → PoolFencer)
- leftScore: Int?
- rightScore: Int?
- winner: String? (LEFT / RIGHT / null)
- status: String (PENDING / IN_PROGRESS / COMPLETED / FORFEIT)

### DAO операции
- Создание группы с участниками и боями
- Обновление результата боя
- Получение всех боёв группы
- Получение текущего / следующего боя
- Получение таблицы результатов
- Поиск спортсменов по имени (автокомплит)
- Пометка спортсмена как исключённого + пересчёт

---

## Доменная логика

### PoolEngine (новый, аналог BoutEngine)
- Чистая бизнес-логика без Android-зависимостей
- Генерация порядка боёв по таблицам FIE
- Расчёт текущей таблицы (матрица + статистика)
- Полный алгоритм ранжирования FIE
- Определение текущего и следующего боя
- Обработка неявок и исключений
- Пересчёт ранжирования при изменении счёта

---

## Компоненты (Decompose)

### Обновлённая навигация
```
RootComponent (Stack Navigation)
├── Child: Home (новый)
│   └── HomeComponent → HomeScreen
├── Child: Bout (существующий)
│   └── BoutComponent → BoutScreen
├── Child: Settings (существующий)
│   └── SettingsComponent → SettingsScreen
├── Child: GroupSetup (новый)
│   └── GroupSetupComponent → GroupSetupScreen
├── Child: GroupDashboard (новый)
│   └── GroupDashboardComponent → GroupDashboardScreen
├── Child: BoutConfirm (новый)
│   └── BoutConfirmComponent → BoutConfirmScreen
├── Child: BoutResult (новый)
│   └── BoutResultComponent → BoutResultScreen
└── Child: BoutsList (новый)
    └── BoutsListComponent → BoutsListScreen
```

---

## PDF экспорт

### Содержание PDF протокола
- Заголовок: "Протокол группы #N"
- Дата и время
- Оружие и режим
- Матрица результатов (таблица FIE)
- Итоговое ранжирование (место, V/M%, индекс, TD, TR)
- Список всех боёв с результатами

### Реализация
- Android Canvas / PDF API (android.graphics.pdf.PdfDocument)
- Share intent для отправки PDF

---

## Многоязычность (i18n)

### Языки
- Русский (основной)
- Английский

### Подход
- strings.xml + strings.xml (en)
- Compose stringResource()
- Фехтовальная терминология: V (Victoire/Victory), D (Défaite/Defeat), TD, TR, Ind

---

## Адаптивный UI

### Телефон (portrait)
- Матрица со скроллом (горизонтальный + вертикальный)
- Закреплённая колонка имён
- Компактные ячейки

### Телефон (landscape)
- Матрица помещается лучше
- Возможность скролла при необходимости

### Планшет
- Матрица 8×8 помещается целиком
- Увеличенные ячейки
- Рядом со списком боёв (split view, опционально)

---

## Ограничения и решения

| Ограничение | Решение |
|---|---|
| Одна активная группа | Достаточно для MVP, архитектура позволяет расширить |
| Нет бэкенда | Локальное хранение Room, архитектура готова к синхронизации |
| Оружие 2 типа | Как в текущем BoutEngine (Sabre / Foil-Épée) |
| Таблицы FIE для 5-8 | Хардкод стандартных таблиц (верифицировать!) |

---

## Открытые вопросы

1. **Точные таблицы FIE** для 7 и 8 участников — нужно верифицировать по официальному регламенту
2. **Правила исключения** при травме — уточнить по регламенту FIE (аннулируются ли все бои или только непроведённые)
3. **BoutScreen**: нужно добавить отображение имён фехтовальщиков (сейчас нет)

---

## Следующие шаги

1. Верифицировать таблицы порядка боёв FIE
2. Спроектировать Room-схему и миграции
3. Реализовать PoolEngine (доменная логика)
4. Реализовать HomeScreen (главный экран выбора)
5. Реализовать GroupSetupScreen
6. Реализовать GroupDashboardScreen с матрицей
7. Интегрировать BoutScreen с групповым этапом
8. Реализовать BoutConfirmScreen и BoutResultScreen
9. Реализовать ранжирование FIE
10. Добавить неявки и исключения
11. Реализовать PDF экспорт
12. Добавить многоязычность (RU + EN)
13. Адаптивный UI (планшет + обе ориентации)
14. Тестирование (unit + UI)
